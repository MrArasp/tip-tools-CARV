// file: index.js
import express from "express";
import { Connection, Keypair, LAMPORTS_PER_SOL, SystemProgram, Transaction, sendAndConfirmTransaction, PublicKey } from "@solana/web3.js";

const app = express();
app.use(express.json());

// اتصال به تست‌نت CARV SVM
const RPC_URL = "https://rpc.testnet.carv.io/rpc";
const connection = new Connection(RPC_URL, "confirmed");

// آدرس کلید فرستنده (تست‌نت)
const secretKey = Uint8Array.from([
  // کلید خصوصی تستی خودت (برای هکاتون - بدون خطر)
]);
const fromWallet = Keypair.fromSecretKey(secretKey);

app.post("/send-tip", async (req, res) => {
  try {
    const { to, amount } = req.body;

    const toPubkey = new PublicKey(to);
    const tx = new Transaction().add(
      SystemProgram.transfer({
        fromPubkey: fromWallet.publicKey,
        toPubkey,
        lamports: amount * LAMPORTS_PER_SOL, // مقدار در SOL (مثلاً 0.01)
      })
    );

    const signature = await sendAndConfirmTransaction(connection, tx, [fromWallet]);
    res.json({ success: true, txHash: signature });
  } catch (err) {
    console.error(err);
    res.status(500).json({ success: false, error: err.message });
  }
});

app.listen(3000, () => console.log("Server running on port 3000"));
